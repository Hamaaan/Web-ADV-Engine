# Issue: セーブ/ロード機能におけるUI表示とゲーム進行の不整合

**概要:**
ゲームのセーブ/ロード機能において、特に選択肢表示中にセーブを行った場合、ロード後のUI表示とゲーム進行に予期せぬ問題が発生しています。

**報告されている問題:**

1.  **選択肢表示中のセーブ・ロードでダイアログボックスが残存する:**
    *   選択肢が表示されている状態でゲームをセーブする。
    *   一度別のダイアログ（またはシーン）に進む。
    *   セーブしたデータをロードすると、本来非表示になるべきダイアログボックスが画面に残ったまま、その上に選択肢が表示されてしまう。

2.  **選択肢表示中のセーブでゲームが前のダイアログに戻る:**
    *   選択肢が表示されている状態でゲームをセーブしようとすると、セーブ操作が完了する前にゲームの進行が予期せず前のダイアログイベントに戻ってしまう。

**原因の分析（推測）:**

*   **問題1（ダイアログボックス残存）:**
    *   `UIManager.showChoices()`は選択肢表示時に`dialogueBox`を非表示にし、`choicesContainer`をクリアするロジックを含んでいます。
    *   しかし、セーブされたゲーム状態（`currentSceneId`, `currentEventIndex`）がロードされた際に、UIの状態（特に`dialogueBox`の表示/非表示）が適切に復元されていない可能性があります。
    *   ロード後に`UIManager.toggleMenuPanel()`が呼び出されますが、これがUIの完全な再描画や状態の同期には不十分であるか、タイミングが遅い可能性があります。ゲームの状態が選択肢イベントを指しているにも関わらず、UIがそれに追いついていない状態と考えられます。

*   **問題2（前のダイアログへのロールバック）:**
    *   セーブ機能自体は`currentSceneId`と`currentEventIndex`を保存するのみであり、直接ゲームをロールバックさせるロジックは含まれていないはずです。
    *   この問題は、セーブ操作がトリガーされるタイミングと、ゲームのイベント処理ループ（特に`Game`クラスの`advanceDialogue`や`processCurrentEvent`）との相互作用に起因する可能性があります。
    *   具体的には、セーブが選択肢イベントに`currentEventIndex`が進む*前*に呼び出されているか、またはセーブ処理中に何らかの形で現在のイベントの再評価がトリガーされ、その結果、UIが前のイベントの状態を再描画してしまっている可能性が考えられます。

**今後の計画:**

1.  **ロード時のUI状態の同期強化:**
    *   `StateManager.loadGame()`が完了した後、`Game`クラス（`main.js`）内で、ロードされた`currentSceneId`と`currentEventIndex`に基づいて、UIを完全に再描画するメカニズムを導入します。
    *   具体的には、ロード後に`Game.processCurrentEvent()`を明示的に呼び出すことで、現在のゲーム状態に合わせたUI（ダイアログまたは選択肢）が確実に表示されるようにします。

2.  **セーブ操作のタイミングとイベント処理の調査:**
    *   `Game.saveGame()`が呼び出される正確なタイミングと、その際にゲームのイベント処理がどのように中断または再開されるかを詳細に調査します。
    *   特に、選択肢表示中にセーブがトリガーされた場合の`currentEventIndex`の値と、ロード後の`currentEventIndex`の値が期待通りであるかを確認します。
    *   必要に応じて、セーブ操作中にゲームの進行を一時停止し、セーブ完了後に再開するようなロジックの調整を検討します。
