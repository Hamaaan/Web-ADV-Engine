# アプリケーション仕様書

## 1. 概要

本アプリケーションは、PlayCanvas をベースとしたノベルゲームエンジンと、そのシナリオを編集するための GUI ツールで構成される。

## 2. ゲームエンジン (`index.html`)

### 2.1. 機能

- プロジェクトルートにある `story.json` ファイルを読み込み、ゲームを開始する。
- `story.json` の記述に従い、以下のイベントを順次処理する。
  - **セリフ (Dialogue):** キャラクター名とテキストを表示する。
  - **選択肢 (Choice):** 複数の選択肢ボタンを表示し、ユーザーの選択に応じて指定されたシーンに遷移する。
  - **終了 (End):** 終了メッセージを表示し、そのシーンを終える。
- ユーザーは画面をクリックすることで、次のイベントへ進行する。
- セリフイベントに `nextSceneId` が指定されている場合、クリックすると直接そのシーンにジャンプする。
- **SE (Sound Effect) 再生:** イベントに `se` プロパティが指定されている場合、対応する効果音を再生する。
- **変数管理:** イベントに `setVar` プロパティが指定されている場合、ゲーム内の変数を設定・更新する。
- **条件分岐:** イベントや選択肢に `condition` プロパティが指定されている場合、変数の値に基づいて表示・実行を制御する。
- **AUTO モード:** 一定時間ごとに自動でセリフを進行させる。
- **SKIP モード:** 未読のセリフや選択肢に到達するまで、高速でセリフをスキップする。
- **LOG 機能:** これまでの会話履歴を表示する。
- **MENU 機能:** ゲームのタイトルへ戻る機能を提供する。
- **タイトル画面:** ゲーム開始時に表示され、`story.json`で設定された背景画像とタイトルテキストを表示する。
- **UI プリセット:** `js/uiPresets.js`と`js/dialogueTextPresets.js`で定義されたプリセットを`story.json`から指定することで、タイトル画面やダイアログのフォントスタイルを一括で変更できる。
- **テキスト送り:** ダイアログのテキストを 1 文字ずつ表示する。`story.json`でデフォルト速度を設定でき、イベントごとに個別の速度を設定可能。また、`<speed:VALUE>`タグにより文中での速度変更も可能。
- **ロードセーブ機能:** ゲームの進行状況（現在のシーン ID、イベントインデックス、変数の値）をブラウザの`localStorage`に保存し、ロード時に復元する。

### 2.2. 画面構成

- **ゲーム画面:** PlayCanvas によって描画される背景やキャラクター（現在は未実装）の表示領域。
- **ダイアログボックス:** 画面下部に表示され、キャラクター名とセリフを表示する。
- **選択肢コンテナ:** 画面中央に表示され、選択肢ボタンを縦に並べて表示する。
- **システムボタン:** 画面右下に MENU, AUTO, LOG, SKIP ボタンを常時表示する。
- **ログパネル:** LOG ボタンクリック時に画面全体を覆い、会話履歴を表示する。
- **メニューパネル:** MENU ボタンクリック時に画面全体を覆い、ゲームオプション（タイトルへ戻る、セーブ、ロードなど）を表示する。
- **タイトル画面:** ゲーム開始時に表示され、ゲームタイトルと「ゲームスタート」ボタン、「つづきから」ボタンを表示する。

## 3. シナリオ編集ツール (`editor/index.html`)

### 3.1. 機能

- **シナリオの読み込み:** `Load CSV` ボタンをクリックすると、ユーザーが選択した CSV ファイルを読み込み、エディタ上に展開する。
- **シナリオの保存:** `Save CSV` ボタンをクリックすると、現在の編集内容を CSV ファイルとしてユーザーのローカルにダウンロードさせる。
- **ゲーム用 JSON のエクスポート:** `Export to story.json` ボタンをクリックすると、現在の編集内容をゲームが読み込む `story.json` 形式に変換し、ユーザーのローカルにダウンロードさせる。
- **シーン管理:**
  - `Add New Scene` ボタンで、新しいシーンをリストの末尾に追加する。
  - 各シーンのヘッダーにある `↑` `↓` ボタンで、シーンの順序を入れ替えることができる。
  - 各シーンのヘッダーにあるゴミ箱アイコンボタンで、該当シーンを削除できる。
  - 左サイドペインにシーン目次（タブ）を実装し、クリックで該当シーンへスクロール、目次からの順序入れ替え・削除機能。
- **イベント管理:**
  - 各シーンの下部にある `Add Event` ボタンで、指定した種類のイベント（セリフ、選択肢、終了）をシーンの末尾に追加できる。
  - 各イベントのヘッダーにある `×` アイコンボタンで、該当イベントを削除できる。
- **内容の編集:**
  - すべてのテキストフィールド（キャラクター名、セリフ、選択肢の文言など）は直接編集が可能。
  - セリフイベントには、次のシーンへ直接ジャンプするための `Next Scene ID` 入力欄がある。
  - **SE (Sound Effect) パス入力欄:** イベント発生時に再生する SE のパスを指定する。
  - **変数設定 (SetVar):** 変数名と値を指定し、イベント発生時に変数を設定する。
  - **条件分岐 (Condition):** 変数名、比較演算子、値を指定し、イベントや選択肢の表示・実行条件を設定する。
  - 選択肢イベントでは、`Add Option` ボタンで選択肢をいくつでも追加でき、各選択肢の横にある `-` アイコンボタンで削除できる。
  - **選択肢ごとの条件分岐:** 各選択肢に個別の条件を設定できる。

### 3.2. 画面構成

- **ツールバー:** 画面上部にあり、CSV ロード、CSV 保存、JSON エクスポート、シーン追加のボタンが配置される。
- **サイドバー:** 画面左側にあり、シーンの目次（タブ）が表示される。目次からシーンの順序変更や削除も可能。
- **メインエディタコンテナ:** ツールバーとサイドバーの右側にあり、読み込まれたシナリオの全シーンが縦に並んで表示される。

## 4. シナリオデータ (`story.json` - ゲーム実行用)

### 4.1. 基本構造

- ルートは単一の JSON オブジェクト。
- `title` (String): ゲームのタイトル。
- `titleScreenBackground` (String, Optional): タイトル画面の背景画像のパス。
- `titleScreenTitle` (String, Optional): タイトル画面に表示するテキスト。
- `textSpeed` (Number, Optional): デフォルトのテキスト送り速度（1 文字あたりのミリ秒）。
- `uiPreset` (String, Optional): UI スタイルプリセットの名前（`uiPresets.js`で定義）。
- `scenes` (Object): シーン ID をキーとし、シーンオブジェクトを値とするオブジェクト。

### 4.2. シーンオブジェクト

- `background` (String): 背景画像のパス。
- `events` (Array): そのシーンで発生するイベントオブジェクトの配列。

### 4.3. イベントオブジェクト

- `type` (String): イベントの種類。`dialogue`, `choice`, `end`, `system` のいずれか。
- `se` (String, Optional): 効果音ファイルのパス。
- `setVar` (Object, Optional): 変数設定オブジェクト。
  - `name` (String): 設定する変数の名前。
  - `value` (String/Number): 設定する変数の値。文字列型で `+=N` や `-=N` と指定すると、既存の数値変数に対して加算・減算を行う。
- `condition` (Object, Optional): イベントの表示・実行条件オブジェクト。
  - `var` (String): 条件となる変数の名前。
  - `op` (String): 比較演算子 (`==`, `!=`, `>`, `<`, `>=`, `<=`)。
  - `value` (String/Number): 条件となる変数の値。
- `textSpeed` (Number, Optional): このイベントに適用されるテキスト送り速度（1 文字あたりのミリ秒）。`story.json`ルートの`textSpeed`より優先される。

- **`dialogue` 型の場合:**

  - `character` (String): キャラクター名。
  - `text` (String): セリフのテキスト。`<style:PRESET_NAME>テキスト</style>`でインラインスタイル、`<speed:VALUE>`タグにより文中速度変更が可能。
  - `nextSceneId` (String, Optional): このセリフの後に遷移するシーンの ID。

- **`choice` 型の場合:**

  - `options` (Array): 選択肢オブジェクトの配列。
    - `text` (String): 選択肢のボタンに表示されるテキスト。
    - `nextSceneId` (String): この選択肢を選んだ場合に遷移するシーンの ID。
    - `condition` (Object, Optional): 選択肢の表示条件オブジェクト。構造はイベントの `condition` と同じ。
    - `setVar` (Object, Optional): この選択肢が選ばれた際に変数を設定する。構造はイベントの `setVar` と同じ。

- **`end` 型の場合:**
  - `message` (String): 画面に表示される終了メッセージ。

## 5. CSV ファイル構造 (エディタ入出力用)

### 5.1. 列定義

| 列名                      | 説明                                                                    | 備考                                            |
| :------------------------ | :---------------------------------------------------------------------- | :---------------------------------------------- |
| `SceneID`                 | シーンの識別子。新しいシーンの最初の行にのみ記述。                      |                                                 |
| `EventType`               | イベントの種類 (`dialogue`, `choice`, `end`)。                          |                                                 |
| `Character`               | `dialogue` イベントの場合のキャラクター名。                             |                                                 |
| `Text`                    | `dialogue` イベントのセリフ、または `end` イベントのメッセージ。        |                                                 |
| `NextSceneID_Dialogue`    | `dialogue` イベントで、クリック後に直接遷移するシーンの ID。            | オプション                                      |
| `SE`                      | 効果音ファイルのパス。                                                  | オプション                                      |
| `SetVar_Name`             | 設定する変数の名前。                                                    | オプション                                      |
| `SetVar_Value`            | 設定する変数の値。                                                      | オプション                                      |
| `Condition_Var`           | イベントの表示・実行条件となる変数の名前。                              | オプション                                      |
| `Condition_Op`            | 条件演算子 (`==`, `!=`, `>`, `<`, `>=`, `<=`)。                         | オプション                                      |
| `Condition_Value`         | 条件となる変数の値。                                                    | オプション                                      |
| `ChoiceN_Text`            | `choice` イベントの場合の N 番目の選択肢のテキスト。                    | `N` は 1 から始まる連番。必要な数だけ列を追加。 |
| `ChoiceN_NextSceneID`     | `choice` イベントの場合の N 番目の選択肢が選ばれた際の遷移先シーン ID。 | `N` は 1 から始まる連番。                       |
| `ChoiceN_Condition_Var`   | N 番目の選択肢の表示条件となる変数の名前。                              | オプション。`N` は 1 から始まる連番。           |
| `ChoiceN_Condition_Op`    | N 番目の選択肢の条件演算子。                                            | オプション。`N` は 1 から始まる連番。           |
| `ChoiceN_Condition_Value` | N 番目の選択肢の条件となる変数の値。                                    | オプション。`N` は 1 から始まる連番。           |
| `Background`              | シーンの背景画像パス。`SceneID` が記述されている行にのみ記述。          |                                                 |

### 5.2. CSV から JSON への変換ルール

- `SceneID` が記述されている行が新しいシーンの開始を示す。
- 同じ `SceneID` の行は、そのシーン内のイベントとして扱われる。
- `ChoiceN_Text` などの `N` が付く列は、動的に選択肢の配列に変換される。
- `SE`, `SetVar_Name`/`SetVar_Value`, `Condition_Var`/`Condition_Op`/`Condition_Value` は、対応する JSON プロパティにマッピングされる。

### 5.3. JSON から CSV への変換ルール

- 各シーンの最初のイベント行に `SceneID` と `Background` が記述される。
- 各イベントのプロパティが対応する CSV 列にマッピングされる。
- `choice` イベントの `options` 配列は、`Choice1_Text`, `Choice2_Text` のようにフラットな列に展開される。
