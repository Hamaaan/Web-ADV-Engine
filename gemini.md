# Gemini Project: PlayCanvas ADV Game

## 概要

このプロジェクトは、PlayCanvasを使用してADV（アドベンチャー）ゲームを開発します。シナリオデータはCSVファイルで管理し、その編集を容易にするための専用ツールも併せて作成します。ゲーム本体はCSVから変換されたJSONファイルを読み込みます。

## プロジェクトの目標

1.  **PlayCanvasでのADVゲーム開発:**
    *   `story.json` を読み込んでシナリオを進行させるゲームの基本システムを構築します。
    *   キャラクター表示、テキスト表示、選択肢などの基本的なADV機能を実装します。
    *   SE再生機能、変数管理・条件分岐機能の追加。

2.  **シナリオ編集ツールの開発:**
    *   ウェブベースのGUIツールを開発します。
    *   CSVファイルの読み込み、編集、保存ができるようにします。
    *   CSVからゲーム用の `story.json` をエクスポートできるようにします。
    *   ユーザーが直感的にシナリオの追加や分岐の作成を行えるインターフェースを目指します。
    *   SE、変数設定、条件分岐の編集機能を追加。

## 技術スタック

*   **ゲームエンジン:** PlayCanvas
*   **シナリオデータ形式:** CSV (編集時), JSON (ゲーム実行時)
*   **編集ツール:** HTML, CSS, JavaScript, Font Awesome

## 完了した作業 (2025/07/17)

*   **ゲーム基本システムの構築:**
    *   `index.html` にてPlayCanvasの基本設定とゲームUIの骨格を実装。
    *   外部の `story.json` を非同期で読み込み、ゲームを開始するロジックを実装。
    *   セリフ、選択肢、終了メッセージの表示機能を実装。
    *   セリフの後に特定のシーンへ直接遷移する機能を実装。
    *   SEの実際の音声再生機能の実装 (HTML5 Audio APIを使用)。
    *   背景画像の表示機能の実装。
    *   キャラクターの立ち絵表示機能の実装。
    *   変数管理・条件分岐機能の基本的なロジックを実装。
    *   ゲーム開始時のSE再生エラー (`NotAllowedError`) の回避策を実装。
    *   初期背景画像が読み込まれない問題の修正。
    *   **エンディング後のクリックで進行しない問題の修正。**
    *   **ダイアログボックスを画面下部に配置。**
    *   **MENU, AUTO, LOG, SKIPボタンのUIを追加。**
    *   **AUTOモード機能の実装（自動送り）。**
    *   **SKIPモード機能の実装（高速スキップ）。**
    *   **LOG機能の実装（会話履歴表示、スタイル付き）。**
    *   **MENU機能の実装（タイトルへ戻る機能）。**
    *   **タイトル画面の実装（`story.json`から背景画像とタイトルテキストをカスタマイズ可能）。**
    *   **UIプリセット機能の実装（`uiPresets.js`と`dialogueTextPresets.js`でフォントスタイルを一括管理）。**
    *   **タイトル画面での`open.mp3`誤再生問題の修正。**
    *   **ゲーム開始時に最初の台詞がスキップされる問題の修正。**
    *   **テキスト送り機能の実装（速度調整、文中での速度変更対応、速度タグのバグ修正）。**
    *   **JavaScriptコードのモジュール化とファイル分割（`GameState.js`, `DialogueManager.js`, `UIManager.js`, `AudioManager.js`, `StateManager.js`, `GameInitializer.js`の独立）。**
    *   **JavaScriptファイルの`js`ディレクトリへの移動と参照パスの修正。**
    *   **ロードセーブ機能の実装（`localStorage`へのゲーム状態の保存と復元、UIフィードバック、ロード時のUI重複バグ修正）。**
    *   **変数管理機能の強化（加算・減算処理に対応）。**
    *   **内部処理用の`system`イベントタイプを追加。**
    *   **ロード時のUI状態の完全なリセット機能の実装（`UIManager.clearUI()`と`DialogueManager.clearText()`の追加と`main.js`での呼び出し）。**
    *   **選択肢表示時に直前のダイアログテキストをダイアログボックスに表示する機能の実装（`main.js`の`processCurrentEvent()`修正、`story.json`から直前イベント参照）。**
    *   **メニュー開閉時に選択肢が消えないようにする修正（`UIManager.toggleMenuPanel()`修正）。**

*   **シナリオ編集ツールのプロトタイプ開発:**
    *   `editor` ディレクトリを作成し、ツール用のHTML, CSS, JSを設置。
    *   `story.json` の読み込みと表示機能を実装。
    *   Font Awesomeを導入し、UIをアイコンで改善。
    *   CSVファイルの読み込み、編集、保存機能の実装。
    *   CSVからゲーム用 `story.json` への変換・エクスポート機能の実装。
    *   SE、変数設定、条件分岐の編集UIとロジックの追加。
    *   キャラクター画像と表示位置の編集UIとロジックの追加。
    *   **シーンの管理:**
        *   シーンの追加、削除機能。
        *   上下ボタンによるシーンの順序入れ替え機能。
        *   左サイドペインにシーン目次（タブ）を実装し、クリックで該当シーンへスクロール、目次からの順序入れ替え・削除機能。
    *   **イベントの管理:**
        *   イベント（セリフ、選択肢、終了）の追加、削除機能。
        *   セリフイベントに、次のシーンIDを指定するフィールドを追加。
    *   **選択肢の管理:**
        *   選択肢の動的な追加、削除機能。
    *   **保存機能:**
        *   編集内容を `story.json` としてダウンロードする機能を実装。

## 今後の計画

*   **ゲーム本体の機能改善:**
    *   ダイアログボックスの表示領域の改善。
    *   エンディング後の `start` シーンへの確実な遷移。

## ファイル構成

*   `index.html`: ゲーム本体のHTMLファイル（PlayCanvasの描画とゲームロジックを含む）
*   `story.json`: シナリオデータ（ゲーム実行用）
*   `js/`
    *   `main.js`: ゲームのメインロジック
    *   `uiPresets.js`: UIスタイルプリセット定義ファイル
    *   `dialogueTextPresets.js`: ダイアログテキストのインラインスタイルプリセット定義ファイル
    *   `GameState.js`: ゲームの状態管理クラス
    *   `DialogueManager.js`: ダイアログ表示とテキスト送り管理クラス
    *   `UIManager.js`: UI要素の表示とイベントハンドリング管理クラス
    *   `AudioManager.js`: オーディオ再生管理クラス
    *   `GameInitializer.js`: ゲーム初期化管理クラス
*   `editor/`
    *   `index.html`: 編集ツールのUI
    *   `editor.js`: 編集ツールのロジック
    *   `style.css`: 編集ツールのスタイル
*   `gemini.md`: プロジェクト管理ファイル
*   `specification.md`: アプリケーション仕様書
*   `issue.md`: 既知の問題と対応状況
